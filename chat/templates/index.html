<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CATCEO</title>
  {% load static %}
  <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" />
  <link rel="stylesheet" href="{% static 'css/wave.css' %}" />
  <link rel="stylesheet" href="{% static 'css/container.css' %}" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #333;
      color: white;
    }
    #chat-box {
      border: 1px solid #ccc;
      padding: 10px;
      height: 60vh;
      overflow-y: scroll;
      margin-bottom: 10px;
      background-color: #444;
      color: white;
    }
    .chat-message {
      margin-bottom: 10px;
    }
    .nickname {
      font-weight: bold;
    }
    .content {
      margin-left: 10px;
    }
    .time {
      font-size: 0.8em;
      color: gray;
      margin-left: 5px;
    }
    .image {
      display: block;
      margin-left: 10px;
      max-width: 100%;
      width: 300px;
      margin-top: 5px;
    }
    .input-container {
      width: 100%;
      box-sizing: border-box;
      padding: 0 10px;
    }
    .input-container input,
    .input-container button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
      background-color: #555;
      color: white;
      border: 1px solid #ccc;
    }
    #container {
      max-width: 800px;
      margin: 0 auto;
      padding: 10px;
    }
    #first-intro {
      font-size: 3em;
      font-weight: bold;
      text-align: center;
      color: white;
    }
    @media (max-width: 800px) {
      #container {
        padding: 10px 0;
      }
    }
  </style>
</head>
<body>
  <br />
  <br />
  <div class="first-intro" id="first-intro">
    CATCEO
  </div>

  <br />
  <br />
  <br />

  <div id="container">
    <!-- Chat Application Section -->
    <div id="chat-box">
      {% for message in messages %}
      <div class="chat-message">
        <span class="nickname">{{ message.Nickname }}</span>
        <span class="time">[{{ message.Time }}]</span>
        <div class="content">{{ message.Content|safe }}</div>
      </div>
      {% endfor %}
    </div>

    <div class="input-container">
      <label for="nickname">Nickname:</label>
      <input type="text" id="nickname" />

      <label for="content">Content:</label>
      <input type="text" id="content" />

      <button id="send-button" onclick="sendMessage()">Send</button>
    </div>

    <!-- Main Page Content -->
    <p class="instruction" id="instruction">
      Using the concept of dog.ceo as a reference, a hypothetical website
      named cat.ceo could have a similar structure but with a feline-centric
      theme. It might feature a business and lifestyle magazine tailored for
      cat lovers, possibly named "Cat CEO Zine." This magazine could offer
      articles, tips, and stories related to cats and their owners.
      Additionally, there could be a "Cats-as-a-Service" API, providing a
      large collection of open-source cat pictures. The website might also
      include sections for cat breed information, advice on cat care, and even
      a section for business advice, but with a humorous twist related to
      cats. The overall theme would blend cats with elements of business and
      lifestyle, targeting cat enthusiasts who enjoy a blend of humor,
      practical advice, and cat-related content.
    </p>
    <br />
    <p class="instruction">
      Please send a photo of your cat that you would like to post on
      <span>cat.ceo</span> via E-MAIL.
    </p>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
  </div>

  <footer class="footer">
    <div class="waves">
      <div class="wave" id="wave1"></div>
      <div class="wave" id="wave2"></div>
      <div class="wave" id="wave3"></div>
      <div class="wave" id="wave4"></div>
    </div>
    <ul class="social-icon">
      <li class="social-icon__item">
        <a
          class="social-icon__link"
          target="_blank"
          href="https://x.com/@catceo_"
        >
          <ion-icon name="logo-twitter"></ion-icon>
        </a>
      </li>
    </ul>
    <ul class="menu">
      <li class="menu__item">
        <a class="menu__link" href="https://x.com/@catceo_">About</a>
      </li>
      <li class="menu__item">
        <a class="menu__link" href="mailto:catceo88@gmail.com">E-mail</a>
      </li>
    </ul>
    <p class="footer_p">&copy;2024 catceo | All Rights Reserved</p>
  </footer>
  <script
    type="module"
    src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
  ></script>
  <script
    nomodule
    src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
  ></script>
  <script>
    function convertToAmericanTime(isoString) {
      const date = new Date(isoString);
      const options = {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        year: "numeric",
        month: "short",
        day: "numeric",
        timeZone: "America/New_York",
        timeZoneName: "short",
      };
      return date.toLocaleString("en-US", options);
    }

    function parseContent(content) {
      const urlPattern = /https:\/\/[^\s]+/g;
      const parts = content.split(urlPattern);
      const urls = content.match(urlPattern) || [];
      let parsedContent = parts.shift();

      const checkImage = (url) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.src = url;
          img.onload = () => resolve(url);
          img.onerror = () => resolve(null);
        });
      };

      const contentElement = document.createElement("div");

      Promise.all(urls.map((url) => checkImage(url))).then((results) => {
        results.forEach((url, index) => {
          if (url) {
            parsedContent += `<br><img src="${url}" class="image"><br>${parts[index]}`;
          }
        });
        contentElement.innerHTML = parsedContent;
      });

      return contentElement;
    }

    function displayMessage(message) {
      const chatBox = document.getElementById("chat-box");
      const messageElement = document.createElement("div");
      messageElement.className = "chat-message";
      messageElement.innerHTML = `
              <span class="nickname">${message.Nickname}</span>
              <span class="time">[${convertToAmericanTime(
                message.Time
              )}]</span>
              <div class="content"></div>
          `;
      const contentElement = parseContent(message.Content);
      messageElement.querySelector(".content").appendChild(contentElement);
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
      const nickname = document.getElementById("nickname").value;
      const content = document.getElementById("content").value;

      const sendButton = document.getElementById("send-button");
      sendButton.disabled = true;

      let countdown = 5;
      const countdownInterval = setInterval(() => {
        if (countdown > 0) {
          sendButton.textContent = `Send (${countdown})`;
          countdown--;
        } else {
          sendButton.textContent = "Send";
          sendButton.disabled = false;
          clearInterval(countdownInterval);
        }
      }, 1000);

      fetch("/send_message/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: `nickname=${nickname}&content=${content}`,
      })
        .then((response) => response.json())
        .then((data) => {
          // 받은 응답을 채팅창에 추가
          if (Array.isArray(data)) {
            data.forEach((message) => displayMessage(message));
          } else {
            displayMessage(data);
          }
          document.getElementById("content").value = ""; // 컨텐츠 필드 비우기
          scrollToBottom();

        })
        .catch((error) => console.error("Error:", error));
    }

    function scrollToBottom() {
      const chatBox = document.getElementById("chat-box");
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 초기 메시지에서 이미지 처리
    document.querySelectorAll(".chat-message .content").forEach((contentElement) => {
      const parsedContent = parseContent(contentElement.innerHTML);
      contentElement.innerHTML = "";
      contentElement.appendChild(parsedContent);
    });

    // 페이지 로드 시 맨 아래로 스크롤
    window.onload = scrollToBottom;

    // 사용자가 스크롤하는지 감지
    let userScrolled = false;

    const chatBox = document.getElementById("chat-box");
    chatBox.addEventListener('scroll', () => {
      userScrolled = true;
    });

    const observer = new MutationObserver(() => {
      if (!userScrolled) {
        scrollToBottom();
      }
    });

    observer.observe(chatBox, { childList: true, subtree: true });
  </script>
</body>
</html>
